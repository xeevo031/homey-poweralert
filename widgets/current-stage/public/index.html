<html>
  <head>
    <style>
      .stage-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        padding: var(--homey-su-4);
      }

      .stage-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: var(--homey-su-4);
        transition: background-color 0.3s ease;
      }

      .stage-number {
        font-size: 48px;
        font-weight: bold;
        color: var(--homey-color-white);
      }

      .stage-info {
        text-align: center;
        width: 100%;
      }

      .stage-description {
        font-size: var(--homey-font-size-regular);
        line-height: var(--homey-line-height-regular);
        color: var(--homey-color-text);
        margin-bottom: var(--homey-su-2);
      }

      .last-update {
        font-size: var(--homey-font-size-small);
        color: var(--homey-color-text-light);
        margin-top: var(--homey-su-2);
      }

      /* Stage colors using semantic colors */
      .stage-0 { background-color: var(--homey-color-success); }
      .stage-1 { background-color: var(--homey-color-success); }
      .stage-2 { background-color: var(--homey-color-warning); }
      .stage-3 { background-color: var(--homey-color-warning); }
      .stage-4 { background-color: var(--homey-color-orange); }
      .stage-5 { background-color: var(--homey-color-orange); }
      .stage-6 { background-color: var(--homey-color-danger); }
      .stage-7 { background-color: var(--homey-color-danger); }
      .stage-8 { background-color: var(--homey-color-danger); }
    </style>
  </head>

  <body class="homey-widget">
    <div class="stage-container">
      <div class="stage-circle" id="stageCircle">
        <div class="stage-number" id="stageNumber">-</div>
      </div>
      <div class="stage-info">
        <div class="stage-description homey-text-regular" id="stageDescription"></div>
        <div class="last-update homey-text-small" id="lastUpdate"></div>
      </div>
    </div>

    <script type="text/javascript">
      function onHomeyReady(Homey) {
        Homey.ready();
        
        const settings = Homey.getSettings();
        
        // Function to format time as HH:MM
        function formatTime(dateString) {
          const date = new Date(dateString);
          return date.toLocaleTimeString('en-GB', { 
            hour: '2-digit', 
            minute: '2-digit'
          });
        }

        // Function to update the widget
        async function updateWidget() {
          try {
            const result = await Homey.api('GET', '/stage');
            
            // Update stage circle
            const stageCircle = document.getElementById('stageCircle');
            const stageNumber = document.getElementById('stageNumber');
            const stageDescription = document.getElementById('stageDescription');
            const lastUpdate = document.getElementById('lastUpdate');
            
            // Remove all stage classes
            stageCircle.classList.remove('stage-0', 'stage-1', 'stage-2', 'stage-3', 
                                      'stage-4', 'stage-5', 'stage-6', 'stage-7', 'stage-8');
            
            // Add appropriate stage class
            stageCircle.classList.add(`stage-${result.stage}`);
            
            // Update content
            stageNumber.textContent = result.stage;
            
            if (settings.showDescription !== false) {
              stageDescription.textContent = result.description;
              stageDescription.style.display = 'block';
            } else {
              stageDescription.style.display = 'none';
            }
            
            if (settings.showLastUpdate !== false) {
              lastUpdate.textContent = `Last updated: ${formatTime(result.lastUpdate)}`;
              lastUpdate.style.display = 'block';
            } else {
              lastUpdate.style.display = 'none';
            }
          } catch (error) {
            console.error('Error updating widget:', error);
          }
        }
        
        // Initial update
        updateWidget();
        
        // Update every minute
        setInterval(updateWidget, 60 * 1000);
      }
    </script>
  </body>
</html>